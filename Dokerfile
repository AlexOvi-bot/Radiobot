# базовый образ
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# установка пакетов
RUN apt-get update && \
    apt-get install -y icecast2 ffmpeg python3 python3-pip supervisor curl && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Рабочая директория
WORKDIR /app

# Копируем код
COPY . /app

# Устанавливаем Python-зависимости
RUN pip3 install -r requirements.txt

# Копируем supervisord конфиг
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Делаем icecast конфиг доступным (будем генерировать/заменять в entrypoint)
COPY icecast.xml.template /app/icecast.xml.template

# Порт, который будет проброшен Railway
EXPOSE 8000

# Entrypoint — скрипт готовит конфиг (под ENV) и запускает supervisord
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

CMD ["/app/entrypoint.sh"]
